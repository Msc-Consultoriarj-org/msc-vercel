# Deploy Vercel + Supabase - Ambiente de Produ√ß√£o

Este guia documenta o processo completo de deploy do **MSC Consultoria** em produ√ß√£o usando **Vercel** (hospedagem) e **Supabase** (banco de dados e autentica√ß√£o).

---

## üéØ Prop√≥sito do Ambiente de Produ√ß√£o

O ambiente de produ√ß√£o √© utilizado para:

- **Vers√µes est√°veis** e maduras das features
- **Uso real** pela equipe MSC Consultoria
- **Alta disponibilidade** e performance
- **Dados de produ√ß√£o** persistentes e seguros
- **Escalabilidade** autom√°tica

---

## üìã Pr√©-requisitos

Antes de iniciar, certifique-se de ter:

- [ ] Conta na [Vercel](https://vercel.com)
- [ ] Conta no [Supabase](https://supabase.com)
- [ ] Reposit√≥rio GitHub: https://github.com/Msc-Consultoriarj-org/msc-consultoria-manus
- [ ] Features testadas e validadas no ambiente Manus

---

## üóÑÔ∏è Parte 1: Configurar Supabase (Banco de Dados)

### 1.1 Criar Projeto no Supabase

1. Acesse [Supabase Dashboard](https://app.supabase.com)
2. Clique em "New Project"
3. Configure:
   - **Name**: `msc-consultoria-prod`
   - **Database Password**: Gere uma senha forte (guarde!)
   - **Region**: `South America (S√£o Paulo)` (mais pr√≥ximo)
   - **Pricing Plan**: Free ou Pro (conforme necessidade)
4. Aguarde ~2 minutos para provisionamento

### 1.2 Obter Credenciais do Banco

1. No dashboard do projeto, v√° em **Settings** ‚Üí **Database**
2. Copie a **Connection String** (modo Pooling):
   ```
   postgresql://postgres:[YOUR-PASSWORD]@db.[PROJECT-REF].supabase.co:6543/postgres
   ```
3. Guarde para usar nas vari√°veis de ambiente

### 1.3 Adaptar Schema para PostgreSQL

O projeto atual usa MySQL. Precisamos adaptar para PostgreSQL:

#### Instalar depend√™ncias PostgreSQL

```bash
cd msc-consultoria
pnpm remove mysql2
pnpm add postgres @neondatabase/serverless
```

#### Atualizar drizzle.config.ts

```typescript
import type { Config } from "drizzle-kit";

export default {
  schema: "./drizzle/schema.ts",
  out: "./drizzle/migrations",
  dialect: "postgresql", // Mudou de mysql para postgresql
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

#### Atualizar drizzle/schema.ts

Substitua os imports e tipos MySQL por PostgreSQL:

```typescript
// Antes (MySQL)
import { mysqlTable, mysqlEnum, int, varchar, text, timestamp } from "drizzle-orm/mysql-core";

// Depois (PostgreSQL)
import { pgTable, pgEnum, serial, varchar, text, timestamp } from "drizzle-orm/pg-core";

// Exemplo de convers√£o de tabela
export const users = pgTable("users", {
  id: serial("id").primaryKey(), // int().autoincrement() ‚Üí serial()
  openId: varchar("openId", { length: 64 }).notNull().unique(),
  name: text("name"),
  email: varchar("email", { length: 320 }),
  loginMethod: varchar("loginMethod", { length: 64 }),
  role: varchar("role", { length: 20 }).default("user").notNull(), // mysqlEnum ‚Üí varchar
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().notNull(),
  lastSignedIn: timestamp("lastSignedIn").defaultNow().notNull(),
});
```

**Nota**: Enums do MySQL devem ser convertidos para `varchar` ou `pgEnum` no PostgreSQL.

#### Atualizar server/db.ts

```typescript
import { drizzle } from "drizzle-orm/postgres-js"; // Mudou de mysql2
import postgres from "postgres";

let _db: ReturnType<typeof drizzle> | null = null;

export async function getDb() {
  if (!_db && process.env.DATABASE_URL) {
    try {
      const client = postgres(process.env.DATABASE_URL);
      _db = drizzle(client);
    } catch (error) {
      console.warn("[Database] Failed to connect:", error);
      _db = null;
    }
  }
  return _db;
}
```

### 1.4 Executar Migra√ß√µes no Supabase

```bash
# Gerar migra√ß√µes para PostgreSQL
pnpm db:push

# Ou manualmente via SQL Editor no Supabase
# Copie o SQL gerado em drizzle/migrations e execute no SQL Editor
```

---

## üîê Parte 2: Configurar Autentica√ß√£o

### Op√ß√£o A: Supabase Auth (Recomendado para Produ√ß√£o)

#### 2.1 Habilitar Providers no Supabase

1. V√° em **Authentication** ‚Üí **Providers**
2. Habilite:
   - **Email** (para login com email/senha)
   - **Google** (opcional, para OAuth)
   - **GitHub** (opcional, para OAuth)

#### 2.2 Configurar Redirect URLs

Em **Authentication** ‚Üí **URL Configuration**:

```
Site URL: https://msc-consultoria-manus.vercel.app
Redirect URLs:
  - https://msc-consultoria-manus.vercel.app/auth/callback
  - http://localhost:3000/auth/callback (para desenvolvimento local)
```

#### 2.3 Obter Credenciais

Em **Settings** ‚Üí **API**:

```
Project URL: https://[PROJECT-REF].supabase.co
anon public key: eyJhbGc...
service_role key: eyJhbGc... (mantenha secreto!)
```

#### 2.4 Adaptar C√≥digo para Supabase Auth

Instale o cliente Supabase:

```bash
pnpm add @supabase/supabase-js
```

Crie `server/_core/supabase.ts`:

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.SUPABASE_URL!;
const supabaseKey = process.env.SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseKey);
```

### Op√ß√£o B: Manter Manus OAuth (Mais Simples)

Se preferir manter a autentica√ß√£o Manus (mais simples, mas menos flex√≠vel):

- Mantenha as vari√°veis de ambiente Manus OAuth
- A autentica√ß√£o continuar√° funcionando igual
- Usu√°rios precisar√£o de conta Manus para acessar

---

## üöÄ Parte 3: Deploy na Vercel

### 3.1 Preparar Projeto para Vercel

O projeto precisa ser adaptado para arquitetura serverless da Vercel.

#### Estrutura de Arquivos

```
msc-consultoria/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ index.js          # Serverless function handler
‚îú‚îÄ‚îÄ client/               # Frontend React
‚îú‚îÄ‚îÄ server/               # Backend tRPC
‚îú‚îÄ‚îÄ vercel.json           # Configura√ß√£o Vercel (j√° criado)
‚îî‚îÄ‚îÄ package.json
```

#### Atualizar package.json

Adicione scripts de build para Vercel:

```json
{
  "scripts": {
    "build": "vite build && pnpm build:server",
    "build:server": "esbuild server/_core/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist"
  }
}
```

### 3.2 Importar Projeto na Vercel

1. Acesse [Vercel Dashboard](https://vercel.com/dashboard)
2. Clique em "Add New" ‚Üí "Project"
3. Importe o reposit√≥rio GitHub:
   ```
   Msc-Consultoriarj-org/msc-consultoria-manus
   ```
4. Configure:
   - **Framework Preset**: Other
   - **Build Command**: `pnpm build`
   - **Output Directory**: `client/dist`
   - **Install Command**: `pnpm install`

### 3.3 Configurar Vari√°veis de Ambiente

Em **Settings** ‚Üí **Environment Variables**, adicione:

#### Banco de Dados (Supabase)

```env
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.[PROJECT-REF].supabase.co:6543/postgres
```

#### Autentica√ß√£o (Supabase)

```env
SUPABASE_URL=https://[PROJECT-REF].supabase.co
SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...
NEXT_PUBLIC_SUPABASE_URL=https://[PROJECT-REF].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
```

#### Ou Manus OAuth (se preferir manter)

```env
JWT_SECRET=[gere-uma-chave-secreta]
VITE_APP_ID=[seu-app-id-manus]
OAUTH_SERVER_URL=https://api.manus.im
VITE_OAUTH_PORTAL_URL=https://manus.im/app-auth
OWNER_OPEN_ID=[seu-open-id]
OWNER_NAME=[seu-nome]
```

#### Outras Vari√°veis

```env
NODE_ENV=production
VITE_APP_TITLE=MSC Consultoria
VITE_APP_LOGO=/msc_logo_concept_04.png
```

### 3.4 Deploy

1. Clique em "Deploy"
2. Aguarde o build (~2-3 minutos)
3. Acesse a URL gerada: `https://msc-consultoria-manus.vercel.app`

---

## üîÑ Parte 4: Workflow de Produ√ß√£o

### 4.1 Fluxo Completo: Desenvolvimento ‚Üí Produ√ß√£o

```
1. [Manus] Desenvolver e testar feature
   ‚Üì
2. [Manus] Validar com equipe
   ‚Üì
3. [Manus] Criar checkpoint final
   ‚Üì
4. [GitHub] Push para branch main
   ‚Üì
5. [Vercel] Deploy autom√°tico em produ√ß√£o
   ‚Üì
6. [Produ√ß√£o] Feature dispon√≠vel para uso real
```

### 4.2 Estrat√©gia de Branches

Recomenda√ß√£o para gerenciar ambientes:

```
main (produ√ß√£o)
  ‚Üë
  ‚îî‚îÄ‚îÄ develop (staging/manus)
       ‚Üë
       ‚îî‚îÄ‚îÄ feature/* (features individuais)
```

#### Workflow Git

```bash
# Desenvolver feature no Manus
git checkout -b feature/nova-funcionalidade
# ... desenvolver ...
git commit -m "feat: nova funcionalidade"
git push origin feature/nova-funcionalidade

# Merge para develop (Manus)
git checkout develop
git merge feature/nova-funcionalidade
git push origin develop

# Testar no Manus
# Quando est√°vel, merge para main (Vercel)
git checkout main
git merge develop
git push origin main
# Deploy autom√°tico na Vercel!
```

### 4.3 Migra√ß√µes de Banco em Produ√ß√£o

**ATEN√á√ÉO**: Migra√ß√µes em produ√ß√£o requerem cuidado!

#### Processo Seguro

1. **Testar no Manus** primeiro:
   ```bash
   pnpm db:push
   ```

2. **Backup do Supabase**:
   - Acesse **Database** ‚Üí **Backups**
   - Crie um backup manual antes da migra√ß√£o

3. **Executar migra√ß√£o**:
   - Via SQL Editor no Supabase (recomendado)
   - Ou via `pnpm db:push` com DATABASE_URL de produ√ß√£o (cuidado!)

4. **Validar**:
   - Verifique se as tabelas foram criadas/atualizadas
   - Teste a aplica√ß√£o em produ√ß√£o

---

## üìä Parte 5: Monitoramento e Logs

### 5.1 Vercel Analytics

1. Acesse **Analytics** no dashboard da Vercel
2. Visualize:
   - Page views
   - Unique visitors
   - Top pages
   - Performance metrics

### 5.2 Vercel Logs

1. Acesse **Deployments** ‚Üí Selecione um deployment
2. Clique em **Functions** para ver logs serverless
3. Filtre por erros ou warnings

### 5.3 Supabase Monitoring

1. Acesse **Database** ‚Üí **Reports**
2. Monitore:
   - Query performance
   - Conex√µes ativas
   - Uso de storage

---

## üîí Parte 6: Seguran√ßa

### 6.1 Row Level Security (RLS) no Supabase

Habilite RLS para proteger dados:

```sql
-- Exemplo: Apenas admins podem deletar funcion√°rios
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admin can delete employees"
ON employees
FOR DELETE
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.role = 'admin'
  )
);
```

### 6.2 Vari√°veis de Ambiente Sens√≠veis

- **NUNCA** commite `.env` no Git
- Use Vercel Environment Variables
- Rotacione secrets periodicamente

### 6.3 CORS e CSP

Configure headers de seguran√ßa no `vercel.json`:

```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        }
      ]
    }
  ]
}
```

---

## üåê Parte 7: Dom√≠nio Customizado

### 7.1 Adicionar Dom√≠nio na Vercel

1. Acesse **Settings** ‚Üí **Domains**
2. Adicione seu dom√≠nio: `mscconsultoria.com.br`
3. Configure DNS:

```
Type: CNAME
Name: @
Value: cname.vercel-dns.com
```

ou

```
Type: A
Name: @
Value: 76.76.21.21
```

4. Aguarde propaga√ß√£o DNS (~24h)

### 7.2 SSL Autom√°tico

A Vercel provisiona SSL automaticamente via Let's Encrypt. Nenhuma configura√ß√£o adicional necess√°ria.

---

## üêõ Troubleshooting

### Erro: "Function Timeout"

**Causa**: Fun√ß√£o serverless excedeu 30s (limite Vercel Free)

**Solu√ß√£o**:
- Otimize queries do banco
- Use caching
- Upgrade para Vercel Pro (60s timeout)

### Erro: "Database Connection Failed"

**Causa**: Credenciais incorretas ou IP bloqueado

**Solu√ß√£o**:
1. Verifique `DATABASE_URL` nas env vars
2. No Supabase, v√° em **Settings** ‚Üí **Database** ‚Üí **Connection Pooling**
3. Use a connection string com pooling (porta 6543)

### Erro: "Build Failed"

**Causa**: Depend√™ncias faltando ou erro de TypeScript

**Solu√ß√£o**:
1. Verifique logs de build na Vercel
2. Rode `pnpm build` localmente para reproduzir
3. Corrija erros de TypeScript

### Deploy N√£o Atualiza

**Causa**: Cache da Vercel

**Solu√ß√£o**:
1. Force redeploy: **Deployments** ‚Üí **...** ‚Üí **Redeploy**
2. Ou limpe cache: **Settings** ‚Üí **General** ‚Üí **Clear Cache**

---

## üìö Recursos Adicionais

- **Documenta√ß√£o Vercel**: https://vercel.com/docs
- **Documenta√ß√£o Supabase**: https://supabase.com/docs
- **Drizzle ORM**: https://orm.drizzle.team
- **tRPC**: https://trpc.io

---

## ‚úÖ Checklist de Deploy em Produ√ß√£o

Antes de fazer deploy em produ√ß√£o:

- [ ] Todas as features testadas no Manus
- [ ] Migra√ß√µes de banco testadas
- [ ] Vari√°veis de ambiente configuradas na Vercel
- [ ] Backup do banco de dados criado
- [ ] RLS habilitado no Supabase (se aplic√°vel)
- [ ] Dom√≠nio customizado configurado (opcional)
- [ ] Monitoramento configurado
- [ ] Documenta√ß√£o atualizada
- [ ] Equipe notificada sobre deploy
- [ ] Plano de rollback preparado

---

## üîÑ Rollback

Se algo der errado em produ√ß√£o:

### Rollback R√°pido (Vercel)

1. Acesse **Deployments**
2. Encontre o deployment anterior est√°vel
3. Clique em **...** ‚Üí **Promote to Production**

### Rollback de Banco (Supabase)

1. Acesse **Database** ‚Üí **Backups**
2. Selecione o backup anterior
3. Clique em **Restore**

---

**Ambiente**: Produ√ß√£o  
**Stack**: React 19 + tRPC + PostgreSQL (Supabase) + Vercel  
**URL**: https://msc-consultoria-manus.vercel.app  
**Status**: Features maduras e validadas no Manus
